%checkout{"ng-controller" => "CheckoutCtrl"}
  = f_form_for current_order, url: main_app.shop_update_checkout_path, html: {name: "checkout", id: "checkout_form"} do |f|

    :javascript
      angular.module('Checkout').value('order', #{render "shop/checkout/order"})
    
    .large-12.columns
      %fieldset#details
        %legend Customer Details
        .row
          .large-6.columns
            = f.text_field :email 
          = f.fields_for :bill_address, @order.bill_address do |ba|
            .large-6.columns
              = ba.text_field :phone 
        = f.fields_for :bill_address, @order.bill_address do |ba|
          .row
            .large-6.columns
              = ba.text_field :firstname, "ng-model" => "order.bill_address.firstname"
            .large-6.columns
              = ba.text_field :lastname, "ng-model" => "order.bill_address.lastname"

        %fieldset
          %legend Billing Address
          = f.fields_for :bill_address, @order.bill_address do |ba|
            .row
              .large-12.columns
                = ba.text_field :address1, label: "Billing Address",
                  "ng-model" => "order.bill_address.address1"
            .row
              .large-12.columns
                = ba.text_field :address2,
                  "ng-model" => "order.bill_address.address2"
            .row
              .large-6.columns
                = ba.text_field :city,
                  "ng-model" => "order.bill_address.city"

              .large-6.columns
                = ba.select :country_id, Spree::Country.order(:name).select([:id, :name]).map{|c| [c.name, c.id]},
                  {}, "ng-model" => "order.bill_address.country_id"
            .row
              .large-6.columns
                = ba.select :state_id, Spree::State.order(:name).select([:id, :name]).map{|c| [c.name, c.id]},
                  "ng-model" => "order.bill_address.state_id"
              .large-6.columns.right
                = ba.text_field :zipcode,
                  "ng-model" => "order.bill_address.zipcode"

      %fieldset#shipping
        %legend Shipping
        - for ship_method, i in current_distributor.shipping_methods.uniq
          .row
            .large-12.columns
              = f.radio_button :shipping_method_id, ship_method.id,
                text: ship_method.name,
                "ng-change" => "shippingMethodChanged()",
                "ng-model" => "order.shipping_method_id"

        = f.fields_for :ship_address, @order.ship_address do |sa|
          #ship_address{"ng-show" => "require_ship_address"}
            %label
              = check_box_tag :same_as_billing, true, true, 
                "ng-model" => "same_as_billing" 
              Shipping address same as billing address?

            %div.visible{"ng-show" => "!same_as_billing"}
              .row
                .large-12.columns
                  = sa.text_field :address1
              .row
                .large-12.columns
                  = sa.text_field :address2

              .row
                .large-6.columns
                  = sa.text_field :city
                .large-6.columns
                  = sa.select :country_id, Spree::Country.order(:name).select([:id, :name]).map{|c| [c.name, c.id]}
              .row
                .large-6.columns.right
                  = sa.text_field :zipcode
              .row
                .large-6.columns
                  = sa.text_field :firstname
                .large-6.columns
                  = sa.text_field :lastname

            #ship_address_hidden{"ng-show" => "same_as_billing"}
              = sa.hidden_field :address1, "ng-value" => "order.bill_address.address1"
              = sa.hidden_field :address2, "ng-value" => "order.bill_address.address2"
              = sa.hidden_field :city, "ng-value" => "order.bill_address.city"
              = sa.hidden_field :country_id, "ng-value" => "order.bill_address.country_id"
              = sa.hidden_field :zipcode, "ng-value" => "order.bill_address.zipcode"
              = sa.hidden_field :firstname, "ng-value" => "order.bill_address.firstname"
              = sa.hidden_field :lastname, "ng-value" => "order.bill_address.lastname"

      %fieldset#payment
        %legend Payment Details
        - current_order.available_payment_methods.each do |method|
          .row
            .large-12.columns
              %label
                = radio_button_tag "order[payments_attributes][][payment_method_id]", method.id, false,
                  "ng-model" => "payment_method"
                = method.name
          .row{"ng-show" => "payment_method == #{method.id}"}
            .large-12.columns
              = render partial: "spree/checkout/payment/#{method.method_type}", :locals => { :payment_method => method }

